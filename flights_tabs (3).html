<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jacob's Flight Log</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Barlow+Condensed:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --black:#080b12;--dark:#0d1220;--card:#111827;--border:#1e2d45;--muted:#1f3050;
  --cyan:#00d4ff;--cyan-dim:#0099bb;--amber:#f59e0b;--green:#10b981;--red:#ef4444;
  --text:#e8f0fe;--text-dim:#7b8fa8;
  --font-display:'Barlow Condensed',sans-serif;--font-mono:'IBM Plex Mono',monospace;
}
html{scroll-behavior:smooth}
body{background:var(--black);color:var(--text);font-family:var(--font-display);font-size:16px;min-height:100vh;overflow-x:hidden}
.site-header{position:relative;padding:32px 40px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,212,255,0.04) 0%,transparent 100%);display:flex;align-items:flex-end;justify-content:space-between;gap:20px;flex-wrap:wrap}
.header-title h1{font-size:clamp(2.5rem,6vw,4.5rem);font-weight:800;letter-spacing:-0.02em;line-height:1;text-transform:uppercase}
.header-title h1 span{color:var(--cyan)}
.header-title p{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-dim);margin-top:8px;letter-spacing:0.1em;text-transform:uppercase}
.header-stats{display:flex;gap:24px;flex-wrap:wrap}
.hstat{text-align:right}
.hstat-val{font-size:clamp(1.6rem,3vw,2.2rem);font-weight:700;color:var(--cyan);line-height:1}
.hstat-lbl{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.12em;margin-top:3px}
.sync-status{position:fixed;top:16px;right:16px;z-index:9998;font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.1em;padding:6px 12px;border-radius:4px;border:1px solid var(--border);background:var(--dark);color:var(--text-dim);display:flex;align-items:center;gap:6px;transition:all 0.3s}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.sync-status.connected .sync-dot{background:var(--green);box-shadow:0 0 6px var(--green)}
.sync-status.connected{color:var(--green);border-color:rgba(16,185,129,0.3)}
.sync-status.syncing .sync-dot{background:var(--amber);animation:pulse 1s infinite}
.sync-status.syncing{color:var(--amber);border-color:rgba(245,158,11,0.3)}
.sync-status.error .sync-dot{background:var(--red)}
.sync-status.error{color:var(--red);border-color:rgba(239,68,68,0.3)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.map-section{position:relative;height:520px;border-bottom:1px solid var(--border)}
.map-label{position:absolute;top:16px;left:20px;z-index:1000;background:rgba(8,11,18,0.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:4px;padding:8px 14px;font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.12em;color:var(--cyan);text-transform:uppercase}
#map{width:100%;height:100%}
.leaflet-tile-pane{filter:saturate(0.2) brightness(0.55) hue-rotate(200deg)}
.leaflet-container{background:#06090f}
.airport-popup .leaflet-popup-content-wrapper{background:var(--dark);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--font-display)}
.airport-popup .leaflet-popup-tip{background:var(--dark)}
.ap-name{font-size:1.1rem;font-weight:700;color:var(--cyan)}
.ap-code{font-family:var(--font-mono);font-size:0.7rem;color:var(--text-dim)}
.ap-stats{margin-top:6px;font-size:0.85rem;color:var(--text-dim)}
.ap-stats b{color:var(--text)}
.map-legend{position:absolute;bottom:24px;right:16px;z-index:1000;background:rgba(8,11,18,0.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:4px;padding:10px 14px;font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim)}
.legend-item{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.legend-item:last-child{margin-bottom:0}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.main{max-width:1600px;margin:0 auto;padding:32px 24px 60px}
.btn{display:inline-flex;align-items:center;gap:7px;font-family:var(--font-mono);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;border:none;border-radius:4px;padding:10px 18px;cursor:pointer;transition:all 0.15s;white-space:nowrap;font-weight:600}
.btn-cyan{background:var(--cyan);color:var(--black)}
.btn-cyan:hover{background:#33ddff;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,212,255,0.3)}
.btn-ghost{background:var(--muted);color:var(--text-dim);font-weight:400}
.btn-ghost:hover{background:#2a4060;color:var(--text)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#f87171}
.btn-del{background:none;border:1px solid transparent;color:var(--text-dim);cursor:pointer;border-radius:3px;padding:3px 8px;font-size:0.8rem;transition:all 0.15s;line-height:1}
.btn-del:hover{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);color:var(--red)}
.search-bar{display:flex;gap:12px;margin-bottom:28px;flex-wrap:wrap;align-items:center}
.search-wrap{position:relative;flex:1;min-width:240px}
.search-wrap svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-dim);pointer-events:none}
input[type=text],select{background:var(--card);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:0.8rem;border-radius:4px;padding:11px 16px;width:100%;outline:none;transition:border-color 0.2s}
input[type=text]:focus,select:focus{border-color:var(--cyan-dim)}
input::placeholder{color:var(--text-dim)}
#searchInput{padding-left:42px}
select{cursor:pointer;min-width:160px;width:auto;appearance:none;padding-right:32px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237b8fa8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
select option{background:var(--dark)}
.search-count{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-dim);white-space:nowrap;align-self:center;min-width:90px;text-align:right}
.search-count span{color:var(--cyan)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:28px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:16px 18px;transition:border-color 0.2s}
.stat-card:hover{border-color:var(--muted)}
.stat-label{font-family:var(--font-mono);font-size:0.6rem;text-transform:uppercase;letter-spacing:0.14em;color:var(--text-dim);margin-bottom:6px}
.stat-value{font-size:2rem;font-weight:700;line-height:1;color:var(--text)}
.stat-value.cyan{color:var(--cyan)}.stat-value.amber{color:var(--amber)}.stat-value.green{color:var(--green)}
.stat-sub{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);margin-top:4px}
.airline-section{margin-bottom:28px}
.section-title{font-family:var(--font-mono);font-size:0.65rem;text-transform:uppercase;letter-spacing:0.15em;color:var(--text-dim);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.airline-bars{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px}
.airline-bar-item{display:flex;align-items:center;gap:10px;cursor:pointer;padding:5px 6px;border-radius:4px;transition:background 0.15s}
.airline-bar-item:hover{background:var(--muted)}.airline-bar-item.active{background:rgba(0,212,255,0.1)}
.airline-name{font-size:0.95rem;font-weight:600;width:90px;flex-shrink:0}
.airline-track{flex:1;height:6px;background:var(--muted);border-radius:3px;overflow:hidden}
.airline-fill{height:100%;border-radius:3px;transition:width 0.6s cubic-bezier(.4,0,.2,1)}
.airline-count{font-family:var(--font-mono);font-size:0.68rem;color:var(--text-dim);width:50px;text-align:right;flex-shrink:0}
.al-American{background:#cc0000}.al-United{background:#005daa}.al-Delta{background:#c01933}
.al-Southwest{background:#f5a623}.al-Frontier{background:#00a94f}.al-Emirates{background:#d71921}
.al-IndiGo{background:#1a0dab}.al-Qatar{background:#5c0632}
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:6px;background:var(--card)}
table{width:100%;border-collapse:collapse;font-size:0.88rem}
thead tr{border-bottom:2px solid var(--border);background:var(--dark)}
th{font-family:var(--font-mono);font-size:0.6rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);padding:12px 14px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:var(--cyan)}
th.sort-asc::after{content:' \2191';color:var(--cyan)}
th.sort-desc::after{content:' \2193';color:var(--cyan)}
tbody tr{border-bottom:1px solid rgba(30,45,69,0.5);transition:background 0.12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(0,212,255,0.04)}
td{padding:10px 14px;white-space:nowrap;vertical-align:middle}
.td-num{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim)}
.td-date{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-dim)}
.route-cell{display:flex;align-items:center;gap:6px;font-weight:700;font-size:1rem}
.route-arrow{color:var(--text-dim);font-size:0.7rem}
.airline-badge{display:inline-block;font-family:var(--font-mono);font-size:0.6rem;padding:2px 7px;border-radius:3px;text-transform:uppercase;letter-spacing:0.05em}
.badge-American{background:rgba(204,0,0,0.2);color:#ff7070}
.badge-United{background:rgba(0,93,170,0.25);color:#6ab4f5}
.badge-Delta{background:rgba(192,25,51,0.2);color:#ff6a7a}
.badge-Southwest{background:rgba(245,166,35,0.2);color:#ffc85a}
.badge-Frontier{background:rgba(0,169,79,0.2);color:#5de89a}
.badge-Emirates{background:rgba(215,25,33,0.2);color:#ff8888}
.badge-IndiGo{background:rgba(26,13,171,0.25);color:#8899ff}
.badge-Qatar{background:rgba(92,6,50,0.35);color:#ff88cc}
.fn-cell{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-dim)}
.ac-cell{font-size:0.82rem;color:var(--text-dim)}
.km-cell{font-family:var(--font-mono);font-size:0.75rem}
.h-cell{font-family:var(--font-mono);font-size:0.75rem;color:var(--amber)}
.comment-cell{font-size:0.78rem;color:var(--text-dim);max-width:200px;white-space:normal;line-height:1.3}
.no-results{padding:60px;text-align:center;color:var(--text-dim);font-family:var(--font-mono);font-size:0.8rem;letter-spacing:0.1em}
.loading-screen{position:fixed;inset:0;z-index:9999;background:var(--black);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity 0.5s}
.loading-screen.hidden{opacity:0;pointer-events:none}
.loading-title{font-size:2rem;font-weight:800;text-transform:uppercase;letter-spacing:0.05em}
.loading-title span{color:var(--cyan)}
.loading-bar{width:240px;height:3px;background:var(--muted);border-radius:2px;overflow:hidden}
.loading-fill{height:100%;background:var(--cyan);border-radius:2px;width:0%;transition:width 0.4s ease}
.loading-msg{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);letter-spacing:0.12em}
.modal-overlay{position:fixed;inset:0;z-index:5000;background:rgba(4,6,12,0.85);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.2s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--dark);border:1px solid var(--border);border-radius:8px;width:100%;max-width:720px;max-height:90vh;overflow-y:auto;transform:translateY(24px) scale(0.98);transition:transform 0.25s cubic-bezier(.4,0,.2,1);box-shadow:0 24px 64px rgba(0,0,0,0.7)}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--dark);z-index:1}
.modal-title{font-size:1.3rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em}
.modal-title span{color:var(--cyan)}
.modal-close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1.6rem;line-height:1;padding:2px 8px;border-radius:4px;transition:all 0.15s}
.modal-close:hover{color:var(--text);background:var(--muted)}
.modal-body{padding:24px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-grid .full{grid-column:1/-1}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-family:var(--font-mono);font-size:0.6rem;text-transform:uppercase;letter-spacing:0.14em;color:var(--text-dim)}
.field input,.field select{background:var(--card);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:0.8rem;border-radius:4px;padding:10px 14px;width:100%;outline:none;transition:border-color 0.2s}
.field input{padding-left:14px}
.field input:focus,.field select:focus{border-color:var(--cyan-dim)}
.field input::placeholder{color:var(--text-dim)}
.field-hint{font-size:0.58rem;opacity:0.7;font-weight:400}
.field input.err,.field select.err{border-color:var(--red)}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding:16px 24px 20px;border-top:1px solid var(--border)}
.confirm-overlay{position:fixed;inset:0;z-index:6000;background:rgba(4,6,12,0.9);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.15s}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:var(--dark);border:1px solid rgba(239,68,68,0.4);border-radius:8px;padding:28px 32px;max-width:400px;width:100%;text-align:center;transform:scale(0.95);transition:transform 0.15s}
.confirm-overlay.open .confirm-box{transform:scale(1)}
.confirm-box h3{font-size:1.2rem;font-weight:700;margin-bottom:10px}
.confirm-box p{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-dim);margin-bottom:22px;line-height:1.6}
.confirm-actions{display:flex;gap:10px;justify-content:center}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);z-index:9999;background:var(--green);color:var(--black);font-family:var(--font-mono);font-size:0.72rem;font-weight:600;letter-spacing:0.08em;padding:12px 20px;border-radius:4px;opacity:0;transition:all 0.3s cubic-bezier(.4,0,.2,1);pointer-events:none;max-width:400px;text-align:center;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{background:var(--red);color:#fff}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--dark)}
::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--cyan-dim)}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.site-header{animation:fadeUp 0.5s ease both}
.map-section{animation:fadeUp 0.5s 0.1s ease both}

/* â”€â”€ PASSWORD SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pw-screen{position:fixed;inset:0;z-index:99999;background:var(--black);display:flex;align-items:center;justify-content:center;padding:24px}
.pw-box{background:var(--dark);border:1px solid var(--border);border-radius:10px;padding:48px 40px;max-width:380px;width:100%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,0.7)}
.pw-icon{font-size:2.4rem;margin-bottom:16px;display:block}
.pw-title{font-size:2rem;font-weight:800;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:6px}
.pw-title span{color:var(--cyan)}
.pw-sub{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);letter-spacing:0.12em;margin-bottom:28px}
.pw-input-wrap{position:relative;margin-bottom:12px}
.pw-input{background:var(--card);border:2px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:1rem;border-radius:6px;padding:14px 48px 14px 18px;width:100%;outline:none;transition:border-color 0.2s;letter-spacing:0.12em;text-align:center}
.pw-input:focus{border-color:var(--cyan-dim)}
.pw-input.err{border-color:var(--red);animation:shake 0.3s ease}
.pw-toggle{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1rem;padding:4px}
.pw-toggle:hover{color:var(--text)}
.pw-btn{width:100%;background:var(--cyan);color:var(--black);font-family:var(--font-mono);font-size:0.75rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;border:none;border-radius:6px;padding:14px;cursor:pointer;transition:all 0.15s;margin-bottom:8px}
.pw-btn:hover{background:#33ddff;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,212,255,0.3)}
.pw-error{font-family:var(--font-mono);font-size:0.65rem;color:var(--red);letter-spacing:0.08em;min-height:16px;margin-top:4px}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar{display:flex;align-items:stretch;border-bottom:1px solid var(--border);background:var(--dark);padding:0 24px;gap:0;position:sticky;top:0;z-index:100}
.tab-btn{font-family:var(--font-mono);font-size:0.68rem;letter-spacing:0.14em;text-transform:uppercase;font-weight:600;padding:16px 28px;background:none;border:none;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;display:flex;align-items:center;gap:8px;white-space:nowrap}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.tab-btn svg{opacity:0.7}
.tab-btn.active svg{opacity:1}
.tab-panel{display:none}
.tab-panel.active{display:block}
.airport-filter-banner{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.25);border-radius:6px;padding:10px 16px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;gap:12px;font-family:var(--font-mono);font-size:0.7rem;color:var(--cyan);letter-spacing:0.08em}
.airport-filter-banner button{background:none;border:1px solid rgba(0,212,255,0.35);color:var(--cyan);font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;padding:4px 12px;border-radius:3px;cursor:pointer;transition:all 0.15s}
.airport-filter-banner button:hover{background:rgba(0,212,255,0.15)}
#airportBanner{display:none}
</style>
</head>
<body>

<div class="pw-screen" id="pwScreen">
  <div class="pw-box">
    <span class="pw-icon">&#9992;</span>
    <div class="pw-title">Jacob's <span>Flight Log</span></div>
    <div class="pw-sub">ENTER PASSWORD TO CONTINUE</div>
    <div class="pw-input-wrap">
      <input class="pw-input" type="password" id="pwInput" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;" autocomplete="off" spellcheck="false">
      <button class="pw-toggle" id="pwToggle" tabindex="-1">&#x1F441;</button>
    </div>
    <div class="pw-error" id="pwError"></div>
    <button class="pw-btn" id="pwSubmit">UNLOCK</button>
  </div>
</div>


<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-title">Jacob's <span>Flight Log</span></div>
  <div class="loading-bar"><div class="loading-fill" id="loadingFill"></div></div>
  <div class="loading-msg" id="loadingMsg">CONNECTING TO DATABASE...</div>
</div>

<!-- Sync Status -->
<div class="sync-status" id="syncStatus">
  <div class="sync-dot"></div>
  <span id="syncText">CONNECTING</span>
</div>

<header class="site-header">
  <div class="header-title">
    <h1>Jacob's <span>Flight Log</span></h1>
    <p>May 2024 &mdash; Present &nbsp;&middot;&nbsp; Personal Aviation Record</p>
  </div>
  <div class="header-stats" id="headerStats"></div>
</header>

<section class="map-section">
  <div class="map-label">&#10022; AIRPORTS VISITED</div>
  <div id="map"></div>
  <div class="map-legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div> AIRPORT</div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(0,212,255,0.4);border:1px solid var(--cyan-dim)"></div> ROUTE ARC</div>
  </div>
</section>

<!-- TAB BAR -->
<div class="tab-bar">
  <button class="tab-btn active" id="tabDashboard" onclick="switchTab('dashboard')">
    <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Dashboard
  </button>
  <button class="tab-btn" id="tabFlights" onclick="switchTab('flights')">
    <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    Flights
  </button>
  <div style="flex:1"></div>
  <button class="tab-btn" id="clearAllBtn" onclick="clearAllFilters()" style="color:var(--cyan);opacity:0;pointer-events:none;transition:opacity 0.2s">
    <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    Clear Filters
  </button>
</div>

<main class="main">

  <!-- Airport filter banner (shared across both tabs) -->
  <div class="airport-filter-banner" id="airportBanner">
    <span>&#9992; Filtered by airport: <strong id="bannerCode"></strong></span>
    <button onclick="clearAirportFilter()">&#10005; Clear</button>
  </div>

  <!-- â”€â”€ DASHBOARD TAB â”€â”€ -->
  <div class="tab-panel active" id="panelDashboard">
    <div class="stats-grid" id="statsGrid"></div>
    <div class="airline-section">
      <div class="section-title">AIRLINE BREAKDOWN &mdash; click to filter</div>
      <div class="airline-bars" id="airlineBars"></div>
    </div>
    <div class="airline-section">
      <div class="section-title">AIRCRAFT TYPE BREAKDOWN &mdash; click to filter</div>
      <div class="airline-bars" id="aircraftBars"></div>
    </div>
    <div class="airline-section">
      <div class="section-title">MANUFACTURER BREAKDOWN &mdash; click to filter</div>
      <div class="airline-bars" id="mfrBars"></div>
    </div>
  </div>

  <!-- â”€â”€ FLIGHTS TAB â”€â”€ -->
  <div class="tab-panel" id="panelFlights">
    <div class="search-bar">
      <div class="search-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input type="text" id="searchInput" placeholder="Search flights, airports, airlines, aircraft&#x2026;">
      </div>
      <select id="airlineFilter">
        <option value="">All Airlines</option>
        <option>American</option><option>United</option><option>Delta</option>
        <option>Southwest</option><option>Frontier</option><option>Emirates</option>
        <option>IndiGo</option><option>Qatar</option>
      </select>
      <select id="mfrFilter">
        <option value="">All Manufacturers</option>
        <option>Boeing</option><option>Airbus</option><option>Embraer</option>
        <option>Bombardier</option><option>ATR</option>
      </select>
      <div class="search-count">Showing <span id="countShown">0</span> / <span id="countTotal">0</span></div>
      <button class="btn btn-ghost admin-only" id="exportBtn" style="background:var(--muted);color:var(--text-dim)"><svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>EXPORT</button>
      <button class="btn btn-cyan admin-only" id="addFlightBtn">
        <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        ADD FLIGHT
      </button>
    </div>
    <div>
      <div class="section-title">COMPLETE FLIGHT LOG</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th data-col="n">#</th>
              <th data-col="date">Date</th>
              <th data-col="dep">Route</th>
              <th data-col="airline">Airline</th>
              <th data-col="fn">Flight</th>
              <th data-col="ac">Aircraft</th>
              <th data-col="mfr">Maker</th>
              <th data-col="km">Distance</th>
              <th data-col="h">Duration</th>
              <th>Notes</th>
              <th class="admin-only"></th>
            </tr>
          </thead>
          <tbody id="flightBody"></tbody>
        </table>
        <div class="no-results" id="noResults" style="display:none">NO FLIGHTS MATCH YOUR SEARCH</div>
      </div>
    </div>
  </div>

</main>

<!-- ADD FLIGHT MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add <span>New Flight</span></div>
      <button class="modal-close" id="modalCloseBtn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field"><label>Date * <span class="field-hint">(e.g. Mar 15, 2026)</span></label><input type="text" id="f-date" placeholder="Mar 15, 2026"></div>
        <div class="field"><label>Flight Number</label><input type="text" id="f-fn" placeholder="e.g. UA1234"></div>
        <div class="field"><label>Departing * <span class="field-hint">(IATA code)</span></label><input type="text" id="f-dep" placeholder="MSN" maxlength="4"></div>
        <div class="field"><label>Arriving * <span class="field-hint">(IATA code)</span></label><input type="text" id="f-arr" placeholder="DFW" maxlength="4"></div>
        <div class="field"><label>Airline *</label>
          <select id="f-airline">
            <option value="">Select airline&#x2026;</option>
            <option>American</option><option>United</option><option>Delta</option>
            <option>Southwest</option><option>Frontier</option><option>Emirates</option>
            <option>IndiGo</option><option>Qatar</option>
            <option value="__other">Other&#x2026;</option>
          </select>
        </div>
        <div class="field" id="airlineOtherWrap" style="display:none"><label>Airline Name *</label><input type="text" id="f-airline-other" placeholder="e.g. Alaska"></div>
        <div class="field"><label>Aircraft <span class="field-hint">(full model)</span></label><input type="text" id="f-ac" placeholder="e.g. 737-824"></div>
        <div class="field"><label>Aircraft Short <span class="field-hint">(e.g. 737)</span></label><input type="text" id="f-acs" placeholder="e.g. 737"></div>
        <div class="field"><label>Manufacturer</label>
          <select id="f-mfr">
            <option value="">Select&#x2026;</option>
            <option>Boeing</option><option>Airbus</option><option>Embraer</option>
            <option>Bombardier</option><option>ATR</option>
            <option value="__other">Other&#x2026;</option>
          </select>
        </div>
        <div class="field" id="mfrOtherWrap" style="display:none"><label>Manufacturer Name</label><input type="text" id="f-mfr-other" placeholder="e.g. Cessna"></div>
        <div class="field"><label>Registration <span class="field-hint">(tail #)</span></label><input type="text" id="f-reg" placeholder="e.g. N814NN"></div>
        <div class="field">
          <label>Duration *</label>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="position:relative;flex:1">
              <input type="number" id="f-h-hrs" placeholder="0" min="0" max="24" style="padding-left:14px;text-align:center">
              <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);pointer-events:none">HRS</span>
            </div>
            <div style="position:relative;flex:1">
              <input type="number" id="f-h-min" placeholder="0" min="0" max="59" style="padding-left:14px;text-align:center">
              <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);pointer-events:none">MIN</span>
            </div>
          </div>
        </div>
        <div class="field"><label>Distance (mi) *</label><input type="text" id="f-km" placeholder="e.g. 821"></div>
        <div class="field full"><label>Notes / Comments</label><input type="text" id="f-comment" placeholder="e.g. First Class, delayed, etc."></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="modalCancelBtn">Cancel</button>
      <button class="btn btn-cyan" id="modalSubmitBtn">
        <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        ADD FLIGHT
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Delete Flight?</h3>
    <p id="confirmMsg">This will remove this flight from your log.</p>
    <div class="confirm-actions">
      <button class="btn btn-ghost" id="confirmCancelBtn">Cancel</button>
      <button class="btn btn-danger" id="confirmDeleteBtn">DELETE</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://sqggnktltpodmytlvray.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxZ2dua3RsdHBvZG15dGx2cmF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDMzOTUsImV4cCI6MjA4NzI3OTM5NX0.gJbWbp6q0bE2XTIdxng3WxigP6VRnuS5m9eZdVeEm98';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Seed data for first-time migration
let FLIGHTS = [
  {n:1,date:"May 17, 2024",airline:"Southwest",fn:"WN250",dep:"DEN",arr:"SJC",ac:"737-8H4",acs:"737",mfr:"Boeing",reg:"N8539V",h:2.12,km:1526,comment:""},
  {n:2,date:"May 31, 2024",airline:"Frontier",fn:"F91094",dep:"SFO",arr:"DEN",ac:"A320-251N",acs:"A320",mfr:"Airbus",reg:"N343FR",h:2.07,km:1556,comment:""},
  {n:3,date:"Jun 01, 2024",airline:"Frontier",fn:"F91093",dep:"DEN",arr:"SFO",ac:"A320-251N",acs:"A320",mfr:"Airbus",reg:"N316FR",h:2.33,km:1556,comment:""},
  {n:4,date:"Jun 11, 2024",airline:"Frontier",fn:"F94000",dep:"SFO",arr:"DFW",ac:"A320-214",acs:"A320",mfr:"Airbus",reg:"N238FR",h:3.02,km:2357,comment:""},
  {n:5,date:"Jun 20, 2024",airline:"American",fn:"AA227",dep:"SJC",arr:"DFW",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N814NN",h:2.87,km:2315,comment:""},
  {n:6,date:"Jun 20, 2024",airline:"American",fn:"AA1736",dep:"DFW",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N816AW",h:1.75,km:1321,comment:""},
  {n:7,date:"Jun 22, 2024",airline:"United",fn:"UA1784",dep:"MSN",arr:"DEN",ac:"A319-131",acs:"A319",mfr:"Airbus",reg:"N829UA",h:2.28,km:1329,comment:""},
  {n:8,date:"Jun 22, 2024",airline:"United",fn:"UA1786",dep:"DEN",arr:"SJC",ac:"A320-232",acs:"A320",mfr:"Airbus",reg:"N484UA",h:2.05,km:1526,comment:""},
  {n:9,date:"Jun 24, 2024",airline:"Qatar",fn:"QR738",dep:"SFO",arr:"DOH",ac:"A350-1041",acs:"A350",mfr:"Airbus",reg:"A7-ANO",h:14.80,km:13014,comment:""},
  {n:10,date:"Jun 25, 2024",airline:"Qatar",fn:"QR528",dep:"DOH",arr:"MAA",ac:"787-8",acs:"787",mfr:"Boeing",reg:"A7-BCF",h:4.22,km:3289,comment:""},
  {n:11,date:"Jun 29, 2024",airline:"IndiGo",fn:"6E7179",dep:"MAA",arr:"TCR",ac:"ATR 72-600",acs:"ATR 72",mfr:"ATR",reg:"VT-IYK",h:1.38,km:528,comment:""},
  {n:12,date:"Jul 03, 2024",airline:"IndiGo",fn:"6E7264",dep:"TCR",arr:"MAA",ac:"ATR 72-600",acs:"ATR 72",mfr:"ATR",reg:"VT-IYO",h:1.60,km:528,comment:""},
  {n:13,date:"Jul 04, 2024",airline:"IndiGo",fn:"6E1321",dep:"MAA",arr:"DOH",ac:"A320-232",acs:"A320",mfr:"Airbus",reg:"VT-IFL",h:3.98,km:3289,comment:""},
  {n:14,date:"Jul 04, 2024",airline:"Qatar",fn:"QR737",dep:"DOH",arr:"SFO",ac:"A350-1041",acs:"A350",mfr:"Airbus",reg:"A7-ANL",h:14.53,km:13014,comment:""},
  {n:15,date:"Jul 20, 2024",airline:"United",fn:"UA1999",dep:"SJC",arr:"DEN",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N33262",h:2.07,km:1526,comment:""},
  {n:16,date:"Jul 27, 2024",airline:"United",fn:"UA1839",dep:"DEN",arr:"SJC",ac:"737-924(ER)",acs:"737",mfr:"Boeing",reg:"N69816",h:2.18,km:1526,comment:""},
  {n:17,date:"Sep 21, 2024",airline:"American",fn:"AA2621",dep:"MKE",arr:"DFW",ac:"A320-214",acs:"A320",mfr:"Airbus",reg:"N114UW",h:2.08,km:1372,comment:""},
  {n:18,date:"Sep 23, 2024",airline:"American",fn:"AA1234",dep:"DFW",arr:"MKE",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N827AW",h:1.92,km:1372,comment:"Delayed by 10 hours 49 Mins"},
  {n:19,date:"Sep 30, 2024",airline:"American",fn:"AA5297",dep:"MSN",arr:"CLT",ac:"CRJ-900LR",acs:"CRJ-900",mfr:"Bombardier",reg:"N618NN",h:1.67,km:1139,comment:"American Eagle; PSA Airlines"},
  {n:20,date:"Sep 30, 2024",airline:"American",fn:"AA5357",dep:"CLT",arr:"ORF",ac:"CRJ-900LR",acs:"CRJ-900",mfr:"Bombardier",reg:"N547NN",h:0.77,km:466,comment:"American Eagle; PSA Airlines"},
  {n:21,date:"Oct 04, 2024",airline:"Southwest",fn:"WN4582",dep:"ORF",arr:"BWI",ac:"737-7H4",acs:"737",mfr:"Boeing",reg:"N238WN",h:0.65,km:257,comment:"American got cancelled again"},
  {n:22,date:"Oct 04, 2024",airline:"Southwest",fn:"WN3588",dep:"BWI",arr:"MKE",ac:"737-8H4",acs:"737",mfr:"Boeing",reg:"N8519R",h:1.73,km:1032,comment:""},
  {n:23,date:"Oct 07, 2024",airline:"United",fn:"UA1784",dep:"MSN",arr:"DEN",ac:"737 MAX 8",acs:"737",mfr:"Boeing",reg:"N17333",h:2.03,km:1329,comment:""},
  {n:24,date:"Oct 07, 2024",airline:"United",fn:"UA5414",dep:"DEN",arr:"MRY",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N203SY",h:2.15,km:1544,comment:"United Express; Skywest Airlines"},
  {n:25,date:"Oct 10, 2024",airline:"United",fn:"UA5401",dep:"MRY",arr:"DEN",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N142SY",h:2.20,km:1544,comment:"United Express; Skywest Airlines"},
  {n:26,date:"Oct 10, 2024",airline:"United",fn:"UA1382",dep:"DEN",arr:"MSN",ac:"737 MAX 8",acs:"737",mfr:"Boeing",reg:"N17264",h:1.78,km:1329,comment:""},
  {n:27,date:"Oct 14, 2024",airline:"American",fn:"AA1082",dep:"DFW",arr:"CLT",ac:"A321 EOW",acs:"A321",mfr:"Airbus",reg:"N118NN",h:1.95,km:1506,comment:"Surprise weekend in Waco"},
  {n:28,date:"Oct 14, 2024",airline:"American",fn:"AA5686",dep:"CLT",arr:"EWN",ac:"ERJ-145LR",acs:"E145",mfr:"Embraer",reg:"N931AE",h:0.58,km:356,comment:"Piedmont Airlines"},
  {n:29,date:"Oct 17, 2024",airline:"American",fn:"AA5778",dep:"EWN",arr:"CLT",ac:"ERJ-145LR",acs:"E145",mfr:"Embraer",reg:"N694PP",h:0.83,km:356,comment:"Piedmont Airlines"},
  {n:30,date:"Oct 17, 2024",airline:"American",fn:"AA5297",dep:"CLT",arr:"MSN",ac:"CRJ-900LR",acs:"CRJ-900",mfr:"Bombardier",reg:"N598NN",h:1.70,km:1506,comment:"American Eagle; PSA Airlines"},
  {n:31,date:"Oct 19, 2024",airline:"United",fn:"UA373",dep:"ORD",arr:"DEN",ac:"777-222",acs:"777",mfr:"Boeing",reg:"N779UA",h:2.03,km:1430,comment:"Going for Tim+Katie wedding"},
  {n:32,date:"Oct 20, 2024",airline:"United",fn:"UA377",dep:"DEN",arr:"ORD",ac:"737 MAX 9",acs:"737",mfr:"Boeing",reg:"N27511",h:1.88,km:1430,comment:"Coming Back from Wedding"},
  {n:33,date:"Oct 28, 2024",airline:"Delta",fn:"DL4972",dep:"MSN",arr:"LGA",ac:"CRJ-900LR",acs:"CRJ-900",mfr:"Bombardier",reg:"N147PQ",h:1.68,km:1306,comment:"Delta Connection; Endeavor Air"},
  {n:34,date:"Oct 31, 2024",airline:"Delta",fn:"DL999",dep:"LGA",arr:"DTW",ac:"A320-212",acs:"A320",mfr:"Airbus",reg:"N372NW",h:1.43,km:807,comment:""},
  {n:35,date:"Oct 31, 2024",airline:"Delta",fn:"DL3166",dep:"DTW",arr:"MSN",ac:"717-232",acs:"717",mfr:"Boeing",reg:"N932AT",h:0.92,km:502,comment:""},
  {n:36,date:"Nov 03, 2024",airline:"American",fn:"AA3657",dep:"MSN",arr:"DFW",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N212NN",h:2.65,km:1320,comment:"American Eagle; Envoy"},
  {n:37,date:"Nov 04, 2024",airline:"American",fn:"AA1340",dep:"DFW",arr:"FLL",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N127AA",h:2.42,km:1800,comment:""},
  {n:38,date:"Nov 07, 2024",airline:"American",fn:"AA2087",dep:"FLL",arr:"CLT",ac:"A321-211",acs:"A321",mfr:"Airbus",reg:"N171US",h:1.80,km:1017,comment:""},
  {n:39,date:"Nov 07, 2024",airline:"American",fn:"AA1168",dep:"CLT",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N820AW",h:1.72,km:1506,comment:""},
  {n:40,date:"Nov 25, 2024",airline:"American",fn:"AA2544",dep:"ORD",arr:"SFO",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N317PG",h:4.65,km:2971,comment:""},
  {n:41,date:"Dec 01, 2024",airline:"American",fn:"AA2614",dep:"SFO",arr:"ORD",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N904NN",h:3.68,km:2971,comment:""},
  {n:42,date:"Dec 20, 2024",airline:"United",fn:"UA2289",dep:"ORD",arr:"SFO",ac:"A321-271NX",acs:"A321",mfr:"Airbus",reg:"N24516",h:3.93,km:2971,comment:""},
  {n:43,date:"Dec 27, 2024",airline:"United",fn:"UA1896",dep:"SFO",arr:"ORD",ac:"A321-271NX",acs:"A321",mfr:"Airbus",reg:"N14518",h:3.63,km:2971,comment:""},
  {n:44,date:"Jan 13, 2025",airline:"United",fn:"UA4715",dep:"MSN",arr:"ORD",ac:"CRJ-550",acs:"CRJ-550",mfr:"Bombardier",reg:"N558GJ",h:0.55,km:175,comment:"EOW Week"},
  {n:45,date:"Jan 13, 2025",airline:"United",fn:"UA2184",dep:"ORD",arr:"SMF",ac:"737 MAX 9",acs:"737",mfr:"Boeing",reg:"N77579",h:4.00,km:2867,comment:""},
  {n:46,date:"Jan 16, 2025",airline:"United",fn:"UA1422",dep:"SMF",arr:"DEN",ac:"737 MAX 8",acs:"737",mfr:"Boeing",reg:"N27260",h:2.02,km:1463,comment:""},
  {n:47,date:"Jan 16, 2025",airline:"United",fn:"UA1483",dep:"DEN",arr:"MSN",ac:"737 MAX 9",acs:"737",mfr:"Boeing",reg:"N27586",h:1.68,km:1329,comment:""},
  {n:48,date:"Jan 24, 2025",airline:"American",fn:"AA2516",dep:"MSN",arr:"DFW",ac:"A319-112",acs:"A319",mfr:"Airbus",reg:"N725UW",h:1.97,km:1321,comment:"January 2025 Waco Trip"},
  {n:49,date:"Jan 27, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N838AW",h:1.73,km:1321,comment:""},
  {n:50,date:"Jan 31, 2025",airline:"Delta",fn:"DL2599",dep:"MSN",arr:"ATL",ac:"717-231",acs:"717",mfr:"Boeing",reg:"N935AT",h:1.67,km:1138,comment:""},
  {n:51,date:"Jan 31, 2025",airline:"Delta",fn:"DL1001",dep:"ATL",arr:"JAX",ac:"757-251",acs:"757",mfr:"Boeing",reg:"N551NW",h:0.77,km:434,comment:""},
  {n:52,date:"Feb 03, 2025",airline:"United",fn:"UA3566",dep:"JAX",arr:"ORD",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N721YX",h:2.32,km:1391,comment:""},
  {n:53,date:"Feb 03, 2025",airline:"United",fn:"UA2184",dep:"ORD",arr:"SMF",ac:"737 MAX 9",acs:"737",mfr:"Boeing",reg:"N27568",h:4.37,km:2867,comment:""},
  {n:54,date:"Feb 06, 2025",airline:"American",fn:"AA2448",dep:"SMF",arr:"DFW",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N563UW",h:2.58,km:2303,comment:""},
  {n:55,date:"Feb 06, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N808AW",h:1.72,km:1321,comment:""},
  {n:56,date:"Feb 14, 2025",airline:"American",fn:"AA3308",dep:"MSN",arr:"DFW",ac:"A319-112",acs:"A319",mfr:"Airbus",reg:"N767UW",h:2.20,km:1321,comment:""},
  {n:57,date:"Feb 16, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N158AN",h:1.78,km:1321,comment:""},
  {n:58,date:"Mar 03, 2025",airline:"United",fn:"UA364",dep:"MSN",arr:"DEN",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N78509",h:2.02,km:1329,comment:""},
  {n:59,date:"Mar 03, 2025",airline:"United",fn:"UA1415",dep:"DEN",arr:"SMF",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N73256",h:2.10,km:1463,comment:""},
  {n:60,date:"Mar 06, 2025",airline:"United",fn:"UA1422",dep:"SMF",arr:"DEN",ac:"737-924ER",acs:"737",mfr:"Boeing",reg:"N75425",h:1.92,km:1463,comment:""},
  {n:61,date:"Mar 09, 2025",airline:"United",fn:"UA1483",dep:"DEN",arr:"MSN",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N73251",h:1.72,km:1329,comment:""},
  {n:62,date:"Mar 30, 2025",airline:"Delta",fn:"DL5645",dep:"MSN",arr:"DCA",ac:"E170SU",acs:"E170",mfr:"Embraer",reg:"N810MD",h:1.67,km:1138,comment:""},
  {n:63,date:"Apr 01, 2025",airline:"Delta",fn:"DL1454",dep:"DCA",arr:"DTW",ac:"A320-212",acs:"A320",mfr:"Airbus",reg:"N362NW",h:1.13,km:656,comment:""},
  {n:64,date:"Apr 01, 2025",airline:"Delta",fn:"DL1106",dep:"DTW",arr:"MSN",ac:"717-231",acs:"717",mfr:"Boeing",reg:"N915AT",h:0.97,km:502,comment:""},
  {n:65,date:"Apr 18, 2025",airline:"American",fn:"AA1826",dep:"MSN",arr:"DFW",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N802AW",h:2.27,km:1321,comment:""},
  {n:66,date:"Apr 20, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A319-112",acs:"A319",mfr:"Airbus",reg:"N709UW",h:1.70,km:1321,comment:""},
  {n:67,date:"May 10, 2025",airline:"American",fn:"AA2007",dep:"MSN",arr:"DFW",ac:"A319-112",acs:"A319",mfr:"Airbus",reg:"N704US",h:2.05,km:1321,comment:""},
  {n:68,date:"May 10, 2025",airline:"American",fn:"AA2585",dep:"DFW",arr:"SJC",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N978NN",h:3.12,km:2315,comment:""},
  {n:69,date:"May 16, 2025",airline:"United",fn:"UA1671",dep:"SJC",arr:"DEN",ac:"A320-232",acs:"A320",mfr:"Airbus",reg:"N476UA",h:2.08,km:1526,comment:""},
  {n:70,date:"May 18, 2025",airline:"United",fn:"UA1483",dep:"DEN",arr:"MSN",ac:"737-924ER",acs:"737",mfr:"Boeing",reg:"N81449",h:2.15,km:1329,comment:""},
  {n:71,date:"May 30, 2025",airline:"United",fn:"UA4603",dep:"MSN",arr:"ORD",ac:"CRJ-550",acs:"CRJ-550",mfr:"Bombardier",reg:"N559GJ",h:0.53,km:175,comment:""},
  {n:72,date:"May 30, 2025",airline:"United",fn:"UA1182",dep:"ORD",arr:"SJC",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N897UA",h:3.72,km:2944,comment:""},
  {n:73,date:"Jun 06, 2025",airline:"Delta",fn:"DL3902",dep:"SJC",arr:"LAX",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N255SY",h:0.88,km:496,comment:""},
  {n:74,date:"Jun 08, 2025",airline:"United",fn:"UA1912",dep:"LAX",arr:"DEN",ac:"757-324",acs:"757",mfr:"Boeing",reg:"N75858",h:2.28,km:1479,comment:""},
  {n:75,date:"Jun 08, 2025",airline:"United",fn:"UA1483",dep:"DEN",arr:"MSN",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N79521",h:1.60,km:1329,comment:""},
  {n:76,date:"Jun 27, 2025",airline:"American",fn:"AA1826",dep:"MSN",arr:"DFW",ac:"A319-112",acs:"A319",mfr:"Airbus",reg:"N771XF",h:2.17,km:1321,comment:""},
  {n:77,date:"Jun 27, 2025",airline:"American",fn:"AA3349",dep:"DFW",arr:"ACT",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N236NN",h:0.33,km:144,comment:""},
  {n:78,date:"Jun 29, 2025",airline:"American",fn:"AA3428",dep:"ACT",arr:"DFW",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N741AK",h:0.67,km:144,comment:""},
  {n:79,date:"Jun 29, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N805AW",h:1.82,km:1321,comment:""},
  {n:80,date:"Jul 18, 2025",airline:"United",fn:"UA2106",dep:"ORD",arr:"SFO",ac:"A321-271NX",acs:"A321",mfr:"Airbus",reg:"N14536",h:4.18,km:2792,comment:""},
  {n:81,date:"Jul 20, 2025",airline:"United",fn:"UA1470",dep:"SFO",arr:"ORD",ac:"777-222",acs:"777",mfr:"Boeing",reg:"N210UA",h:3.42,km:2792,comment:""},
  {n:82,date:"Aug 01, 2025",airline:"United",fn:"UA5993",dep:"MSN",arr:"DEN",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N131SY",h:2.40,km:1329,comment:""},
  {n:83,date:"Aug 01, 2025",airline:"United",fn:"UA2368",dep:"DEN",arr:"SNA",ac:"737 MAX 8",acs:"737",mfr:"Boeing",reg:"N27253",h:2.00,km:1361,comment:""},
  {n:84,date:"Aug 10, 2025",airline:"United",fn:"UA374",dep:"SJC",arr:"ORD",ac:"A320-232",acs:"A320",mfr:"Airbus",reg:"N490UA",h:4.80,km:2944,comment:""},
  {n:85,date:"Aug 10, 2025",airline:"United",fn:"UA2177",dep:"ORD",arr:"MSN",ac:"A319-131",acs:"A319",mfr:"Airbus",reg:"N854UA",h:0.43,km:175,comment:""},
  {n:86,date:"Sep 06, 2025",airline:"Delta",fn:"DL1264",dep:"ORD",arr:"ATL",ac:"A321-211",acs:"A321",mfr:"Airbus",reg:"N107DN",h:1.53,km:975,comment:""},
  {n:87,date:"Sep 06, 2025",airline:"Delta",fn:"DL2923",dep:"ATL",arr:"JAX",ac:"757-251",acs:"757",mfr:"Boeing",reg:"N544US",h:0.70,km:434,comment:""},
  {n:88,date:"Sep 07, 2025",airline:"American",fn:"AA2789",dep:"JAX",arr:"DFW",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N815NN",h:2.17,km:1478,comment:""},
  {n:89,date:"Sep 07, 2025",airline:"American",fn:"AA1937",dep:"DFW",arr:"BZN",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N876NN",h:2.63,km:1872,comment:""},
  {n:90,date:"Sep 13, 2025",airline:"American",fn:"AA817",dep:"BZN",arr:"DFW",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N980NN",h:2.60,km:1872,comment:""},
  {n:91,date:"Sep 14, 2025",airline:"American",fn:"AA2346",dep:"DFW",arr:"ORD",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N827NN",h:1.73,km:1290,comment:""},
  {n:92,date:"Sep 22, 2025",airline:"American",fn:"AA797",dep:"MSN",arr:"DFW",ac:"A320-214",acs:"A320",mfr:"Airbus",reg:"N124US",h:2.33,km:1321,comment:""},
  {n:93,date:"Sep 22, 2025",airline:"American",fn:"AA2078",dep:"DFW",arr:"SMF",ac:"737-823",acs:"737",mfr:"Boeing",reg:"N352PS",h:3.23,km:2303,comment:""},
  {n:94,date:"Sep 26, 2025",airline:"American",fn:"AA1544",dep:"SMF",arr:"DFW",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N154AA",h:3.02,km:2303,comment:""},
  {n:95,date:"Sep 28, 2025",airline:"American",fn:"AA4081",dep:"ACT",arr:"DFW",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N323ED",h:0.53,km:144,comment:"First Class ðŸ˜Ž"},
  {n:96,date:"Sep 28, 2025",airline:"American",fn:"AA876",dep:"DFW",arr:"MSN",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N551UW",h:1.82,km:1321,comment:"First Class ðŸ˜Ž"},
  {n:97,date:"Oct 03, 2025",airline:"United",fn:"UA5993",dep:"MSN",arr:"DEN",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N167SY",h:1.87,km:1329,comment:""},
  {n:98,date:"Oct 03, 2025",airline:"United",fn:"UA1229",dep:"DEN",arr:"SFO",ac:"737 MAX 9",acs:"737",mfr:"Boeing",reg:"N37521",h:2.42,km:1556,comment:""},
  {n:99,date:"Oct 09, 2025",airline:"American",fn:"AA1804",dep:"SFO",arr:"DFW",ac:"A321-231",acs:"A321",mfr:"Airbus",reg:"N147AA",h:2.80,km:2357,comment:""},
  {n:100,date:"Oct 09, 2025",airline:"American",fn:"AA1736",dep:"DFW",arr:"MSN",ac:"A320-214",acs:"A320",mfr:"Airbus",reg:"N124US",h:1.88,km:1321,comment:""},
  {n:101,date:"Oct 31, 2025",airline:"American",fn:"AA5647",dep:"MSN",arr:"DCA",ac:"CRJ-702ER",acs:"CRJ-700",mfr:"Bombardier",reg:"N534AE",h:1.55,km:1138,comment:"PSA Airlines; American Eagle"},
  {n:102,date:"Nov 07, 2025",airline:"United",fn:"UA1667",dep:"EWR",arr:"MSN",ac:"A319-132",acs:"A319",mfr:"Airbus",reg:"N872UA",h:2.12,km:1285,comment:""},
  {n:103,date:"Nov 22, 2025",airline:"United",fn:"UA2748",dep:"MSN",arr:"DEN",ac:"A320-232",acs:"A320",mfr:"Airbus",reg:"N443UA",h:1.92,km:1329,comment:""},
  {n:104,date:"Dec 01, 2025",airline:"United",fn:"UA1208",dep:"DEN",arr:"SMF",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N17229",h:2.07,km:1463,comment:""},
  {n:105,date:"Dec 05, 2025",airline:"United",fn:"UA1278",dep:"SMF",arr:"ORD",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N77536",h:3.63,km:2867,comment:""},
  {n:106,date:"Dec 05, 2025",airline:"United",fn:"UA1049",dep:"ORD",arr:"MSN",ac:"A319-131",acs:"A319",mfr:"Airbus",reg:"N834UA",h:0.52,km:175,comment:""},
  {n:107,date:"Dec 23, 2025",airline:"Emirates",fn:"EK236",dep:"ORD",arr:"DXB",ac:"777-300ER",acs:"777",mfr:"Boeing",reg:"A6-EQO",h:12.97,km:11655,comment:""},
  {n:108,date:"Dec 24, 2025",airline:"Emirates",fn:"EK542",dep:"DXB",arr:"MAA",ac:"777-31HER",acs:"777",mfr:"Boeing",reg:"A6-EPQ",h:3.30,km:2937,comment:""},
  {n:109,date:"Dec 25, 2025",airline:"IndiGo",fn:"6E7193",dep:"MAA",arr:"TCR",ac:"ATR 72-600",acs:"ATR 72",mfr:"ATR",reg:"VT-IYP",h:1.28,km:528,comment:"Baby land in Thoothukudiiiii"},
  {n:110,date:"Jan 03, 2026",airline:"IndiGo",fn:"6E7606",dep:"TCR",arr:"MAA",ac:"ATR 72-600",acs:"ATR 72",mfr:"ATR",reg:"VT-IYL",h:1.35,km:528,comment:""},
  {n:111,date:"Jan 04, 2026",airline:"Emirates",fn:"EK545",dep:"MAA",arr:"DXB",ac:"777-31HER",acs:"777",mfr:"Boeing",reg:"A6-EGS",h:3.67,km:2937,comment:""},
  {n:112,date:"Jan 05, 2026",airline:"Emirates",fn:"EK235",dep:"DXB",arr:"ORD",ac:"777-300ER",acs:"777",mfr:"Boeing",reg:"A6-EQP",h:14.17,km:11655,comment:""},
  {n:113,date:"Feb 13, 2026",airline:"Delta",fn:"DL2599",dep:"MSN",arr:"ATL",ac:"717-2BD",acs:"717",mfr:"Boeing",reg:"N946AT",h:1.48,km:1138,comment:""},
  {n:114,date:"Feb 13, 2026",airline:"Delta",fn:"DL1335",dep:"ATL",arr:"AUS",ac:"A320-211",acs:"A320",mfr:"Airbus",reg:"N325US",h:2.17,km:1308,comment:""},
  {n:115,date:"Feb 16, 2026",airline:"United",fn:"UA2447",dep:"AUS",arr:"DEN",ac:"737-824",acs:"737",mfr:"Boeing",reg:"N76528",h:1.92,km:1247,comment:""},
  {n:116,date:"Feb 16, 2026",airline:"United",fn:"UA4672",dep:"DEN",arr:"BFL",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N114SY",h:2.65,km:1359,comment:""},
  {n:117,date:"Feb 20, 2026",airline:"United",fn:"UA4764",dep:"FAT",arr:"DEN",ac:"E175LR",acs:"E175",mfr:"Embraer",reg:"N118SY",h:1.82,km:1358,comment:""},
  {n:118,date:"Feb 20, 2026",airline:"United",fn:"UA1894",dep:"DEN",arr:"MSN",ac:"737-924(ER)",acs:"737",mfr:"Boeing",reg:"N64809",h:1.78,km:1329,comment:""}
];

const AIRPORTS = {
  ACT:{lat:31.6113,lon:-97.2265,name:"Waco Regional"},
  ATL:{lat:33.6407,lon:-84.4277,name:"Hartsfield-Jackson Atlanta"},
  AUS:{lat:30.1975,lon:-97.6664,name:"Austin-Bergstrom Intl"},
  BFL:{lat:35.4336,lon:-119.0568,name:"Bakersfield Meadows Field"},
  BWI:{lat:39.1754,lon:-76.6683,name:"Baltimore/Washington Intl"},
  BZN:{lat:45.7772,lon:-111.1531,name:"Bozeman Yellowstone Intl"},
  CLT:{lat:35.2141,lon:-80.9431,name:"Charlotte Douglas Intl"},
  DCA:{lat:38.8521,lon:-77.0377,name:"Ronald Reagan Washington"},
  DEN:{lat:39.8561,lon:-104.6737,name:"Denver Intl"},
  DFW:{lat:32.8998,lon:-97.0403,name:"Dallas/Fort Worth Intl"},
  DOH:{lat:25.2731,lon:51.608,name:"Hamad Intl (Doha)"},
  DTW:{lat:42.2124,lon:-83.3534,name:"Detroit Metropolitan"},
  DXB:{lat:25.2528,lon:55.3644,name:"Dubai Intl"},
  EWN:{lat:35.073,lon:-77.0429,name:"Coastal Carolina Regional"},
  EWR:{lat:40.6895,lon:-74.1745,name:"Newark Liberty Intl"},
  FAT:{lat:36.7762,lon:-119.7181,name:"Fresno Yosemite Intl"},
  FLL:{lat:26.0726,lon:-80.1527,name:"Fort Lauderdale-Hollywood"},
  JAX:{lat:30.4941,lon:-81.6879,name:"Jacksonville Intl"},
  LAX:{lat:33.9425,lon:-118.4081,name:"Los Angeles Intl"},
  LGA:{lat:40.7769,lon:-73.874,name:"LaGuardia"},
  MAA:{lat:12.9941,lon:80.1709,name:"Chennai Intl"},
  MKE:{lat:42.9472,lon:-87.8966,name:"Milwaukee Mitchell Intl"},
  MRY:{lat:36.587,lon:-121.843,name:"Monterey Regional"},
  MSN:{lat:43.1399,lon:-89.3375,name:"Dane County Regional (Madison)"},
  ORD:{lat:41.9742,lon:-87.9073,name:"Chicago O'Hare Intl"},
  ORF:{lat:36.8976,lon:-76.0121,name:"Norfolk Intl"},
  SFO:{lat:37.6213,lon:-122.379,name:"San Francisco Intl"},
  SJC:{lat:37.3639,lon:-121.9289,name:"San Jose Mineta Intl"},
  SMF:{lat:38.6954,lon:-121.5911,name:"Sacramento Intl"},
  SNA:{lat:33.6757,lon:-117.8682,name:"John Wayne (Orange County)"},
  TCR:{lat:10.7654,lon:79.8419,name:"Tuticorin Airport"}
};

var flightData=[],filtered=[],sortCol='n',sortDir=1,activeAirline='',activeAircraft='',activeMfr='',activeAirport='',pendingDeleteId=null,mapLayers=[];

// â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');});
  document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
  document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
  document.getElementById('panel'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
}

// â”€â”€ CLEAR ALL FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClearBtn(){
  var hasFilters=activeAirport||activeAirline||activeAircraft||
    document.getElementById('searchInput').value||
    document.getElementById('airlineFilter').value||
    document.getElementById('mfrFilter').value;
  var btn=document.getElementById('clearAllBtn');
  btn.style.opacity=hasFilters?'1':'0';
  btn.style.pointerEvents=hasFilters?'auto':'none';
}

function clearAllFilters(){
  activeAirport='';activeAirline='';activeAircraft='';activeMfr='';
  document.getElementById('searchInput').value='';
  document.getElementById('airlineFilter').value='';
  document.getElementById('mfrFilter').value='';
  document.getElementById('airportBanner').style.display='none';
  renderMap();
  applyFilters();
}
function setAirportFilter(code){
  activeAirport=code;
  var banner=document.getElementById('airportBanner');
  if(code){
    document.getElementById('bannerCode').textContent=code+' â€” '+(AIRPORTS[code]?AIRPORTS[code].name:code);
    banner.style.display='flex';
  } else {
    banner.style.display='none';
  }
  applyFilters();
}
function clearAirportFilter(){
  setAirportFilter('');
  // also clear search box if it was set by map click
  if(document.getElementById('searchInput').value===activeAirport){
    document.getElementById('searchInput').value='';
  }
  applyFilters();
}

// â”€â”€ SYNC STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(state,text){
  var el=document.getElementById('syncStatus');
  el.className='sync-status '+state;
  document.getElementById('syncText').textContent=text;
}

// â”€â”€ LOADING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(pct,msg){
  document.getElementById('loadingFill').style.width=pct+'%';
  document.getElementById('loadingMsg').textContent=msg;
}
function hideLoading(){
  var el=document.getElementById('loadingScreen');
  el.classList.add('hidden');
  setTimeout(function(){el.style.display='none';},600);
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var map=L.map('map',{center:[30,-20],zoom:2,worldCopyJump:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap',maxZoom:18}).addTo(map);

function geodesicArc(a,b,c,d){var e=80,R=Math.PI/180,D=180/Math.PI,p1=a*R,l1=b*R,p2=c*R,l2=d*R,dist=2*Math.asin(Math.sqrt(Math.pow(Math.sin((p2-p1)/2),2)+Math.cos(p1)*Math.cos(p2)*Math.pow(Math.sin((l2-l1)/2),2)));if(dist===0)return[[a,b],[c,d]];var pts=[];for(var i=0;i<=e;i++){var f=i/e,A=Math.sin((1-f)*dist)/Math.sin(dist),B=Math.sin(f*dist)/Math.sin(dist),x=A*Math.cos(p1)*Math.cos(l1)+B*Math.cos(p2)*Math.cos(l2),y=A*Math.cos(p1)*Math.sin(l1)+B*Math.cos(p2)*Math.sin(l2),z=A*Math.sin(p1)+B*Math.sin(p2);pts.push([Math.atan2(z,Math.sqrt(x*x+y*y))*D,Math.atan2(y,x)*D]);}return pts;}

function renderMap(){
  mapLayers.forEach(function(l){map.removeLayer(l);});mapLayers=[];
  var rm={};
  flightData.forEach(function(f){var k=[f.dep,f.arr].sort().join('-');if(!rm[k])rm[k]={dep:f.dep,arr:f.arr,count:0};rm[k].count++;});
  Object.values(rm).forEach(function(r){var A=AIRPORTS[r.dep],B=AIRPORTS[r.arr];if(!A||!B)return;var l=L.polyline(geodesicArc(A.lat,A.lon,B.lat,B.lon),{color:'rgba(0,212,255,0.35)',weight:Math.min(1+r.count*0.3,3),opacity:1,smoothFactor:1,interactive:false}).addTo(map);mapLayers.push(l);});
  var cnt={};flightData.forEach(function(f){cnt[f.dep]=(cnt[f.dep]||0)+1;cnt[f.arr]=(cnt[f.arr]||0)+1;});
  var used=new Set(flightData.map(function(f){return f.dep;}).concat(flightData.map(function(f){return f.arr;})));
  used.forEach(function(code){
    var ap=AIRPORTS[code];if(!ap)return;
    var c=cnt[code]||0,r=Math.max(5,Math.min(12,5+c*0.5));
    var deps=flightData.filter(function(f){return f.dep===code;}).length,arrs=flightData.filter(function(f){return f.arr===code;}).length;
    var isActive=activeAirport===code;
    var mk=L.circleMarker([ap.lat,ap.lon],{
      radius:isActive?r+3:r,
      fillColor:isActive?'#ffffff':'#00d4ff',
      fillOpacity:0.9,
      color:isActive?'#00d4ff':'#003344',
      weight:isActive?2.5:1.5
    }).addTo(map);
    mk.bindPopup("<div class='ap-name'>"+ap.name+"</div><div class='ap-code'>"+code+"</div><div class='ap-stats'><b>"+(deps+arrs)+"</b> flights &middot; <b>"+deps+"</b> dep &middot; <b>"+arrs+"</b> arr</div>",{className:'airport-popup',maxWidth:240});
    mk.on('click',function(e){
      L.DomEvent.stopPropagation(e);
      if(activeAirport===code){
        setAirportFilter('');
      } else {
        setAirportFilter(code);
      }
      renderMap();
    });
    mapLayers.push(mk);
  });
}

// Clicking the map background clears airport filter
map.on('click',function(){
  if(activeAirport){setAirportFilter('');renderMap();}
});

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtH(h){var hh=Math.floor(h),mm=Math.round((h-hh)*60);return hh+'h '+String(mm).padStart(2,'0')+'m';}
function showToast(msg,err){var t=document.getElementById('toast');t.textContent=msg;t.classList.toggle('error',!!err);t.classList.add('show');clearTimeout(window._tt);window._tt=setTimeout(function(){t.classList.remove('show');},3500);}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(){
  filtered=[...flightData];
  applyFilters();
  renderMap();
}

function renderHeaderStats(data){
  var h=data.reduce(function(a,f){return a+f.h;},0),km=data.reduce(function(a,f){return a+f.km;},0);
  var aps=new Set(data.map(function(f){return f.dep;}).concat(data.map(function(f){return f.arr;}))).size;
  var als=new Set(data.map(function(f){return f.airline;})).size;
  document.getElementById('headerStats').innerHTML='<div class="hstat"><div class="hstat-val">'+data.length+'</div><div class="hstat-lbl">Flights</div></div><div class="hstat"><div class="hstat-val">'+Math.round(h)+'h</div><div class="hstat-lbl">In the Air</div></div><div class="hstat"><div class="hstat-val">'+Math.round(km*0.621371/1000)+'k</div><div class="hstat-lbl">Miles</div></div><div class="hstat"><div class="hstat-val">'+aps+'</div><div class="hstat-lbl">Airports</div></div><div class="hstat"><div class="hstat-val">'+als+'</div><div class="hstat-lbl">Airlines</div></div>';
}

function renderStats(data){
  if(!data.length){document.getElementById('statsGrid').innerHTML='';return;}
  var h=data.reduce(function(a,f){return a+f.h;},0),km=data.reduce(function(a,f){return a+f.km;},0);
  var longest=data.reduce(function(a,f){return f.km>a.km?f:a;},{km:0,dep:'',arr:'',h:0});
  var shortest=data.reduce(function(a,f){return f.km<a.km?f:a;},{km:Infinity,dep:'',arr:'',h:0});
  var acT=new Set(data.map(function(f){return f.acs;})).size;
  var mfrCounts={};data.forEach(function(f){if(f.mfr)mfrCounts[f.mfr]=(mfrCounts[f.mfr]||0)+1;});
  var topMfr=Object.entries(mfrCounts).sort(function(a,b){return b[1]-a[1];})[0]||['Unknown',0];
  var topMfrPct=Math.round(topMfr[1]/data.length*100);
  document.getElementById('statsGrid').innerHTML='<div class="stat-card"><div class="stat-label">Total Distance</div><div class="stat-value cyan">'+Math.round(km*0.621371).toLocaleString()+'</div><div class="stat-sub">miles flown</div></div><div class="stat-card"><div class="stat-label">Total Time</div><div class="stat-value amber">'+h.toFixed(1)+'h</div><div class="stat-sub">'+(h/24).toFixed(1)+' days in the air</div></div><div class="stat-card"><div class="stat-label">Unique Airports</div><div class="stat-value green">'+new Set(data.map(function(f){return f.dep;}).concat(data.map(function(f){return f.arr;}))).size+'</div><div class="stat-sub">cities visited</div></div><div class="stat-card"><div class="stat-label">Aircraft Types</div><div class="stat-value">'+acT+'</div><div class="stat-sub">unique variants</div></div><div class="stat-card"><div class="stat-label">Longest Flight</div><div class="stat-value" style="font-size:1.4rem">'+longest.dep+' &rarr; '+longest.arr+'</div><div class="stat-sub">'+Math.round(longest.km*0.621371).toLocaleString()+' mi &middot; '+fmtH(longest.h)+'</div></div><div class="stat-card"><div class="stat-label">Shortest Flight</div><div class="stat-value" style="font-size:1.4rem">'+shortest.dep+' &rarr; '+shortest.arr+'</div><div class="stat-sub">'+Math.round(shortest.km*0.621371)+' mi &middot; '+fmtH(shortest.h)+'</div></div><div class="stat-card"><div class="stat-label">Top Manufacturer</div><div class="stat-value">'+topMfrPct+'%</div><div class="stat-sub">'+topMfr[0]+'</div></div><div class="stat-card"><div class="stat-label">Avg Flight</div><div class="stat-value">'+Math.round(km*0.621371/data.length).toLocaleString()+'</div><div class="stat-sub">miles per flight</div></div>';
}

function renderAirlineBars(data){
  var counts={};data.forEach(function(f){counts[f.airline]=(counts[f.airline]||0)+1;});
  var sorted=Object.entries(counts).sort(function(a,b){return b[1]-a[1];});var max=sorted[0]?sorted[0][1]:1;
  document.getElementById('airlineBars').innerHTML=sorted.map(function(e){var al=e[0],cnt=e[1];return '<div class="airline-bar-item'+(activeAirline===al?' active':'')+'" data-airline="'+al+'"><div class="airline-name">'+al+'</div><div class="airline-track"><div class="airline-fill al-'+al+'" style="width:'+(cnt/max*100).toFixed(1)+'%"></div></div><div class="airline-count">'+cnt+' flights</div></div>';}).join('');
  document.querySelectorAll('.airline-bar-item').forEach(function(el){el.addEventListener('click',function(){var al=this.dataset.airline;if(activeAirline===al){activeAirline='';document.getElementById('airlineFilter').value='';}else{activeAirline=al;document.getElementById('airlineFilter').value=al;}applyFilters();});});
}

function renderAircraftBars(data){
  var counts={};data.forEach(function(f){if(f.acs)counts[f.acs]=(counts[f.acs]||0)+1;});
  var sorted=Object.entries(counts).sort(function(a,b){return b[1]-a[1];});var max=sorted[0]?sorted[0][1]:1;
  var colors=['#00d4ff','#f59e0b','#10b981','#a78bfa','#f87171','#60a5fa','#34d399','#fb923c','#c084fc','#e879f9'];
  document.getElementById('aircraftBars').innerHTML=sorted.map(function(e,i){var ac=e[0],cnt=e[1];var col=colors[i%colors.length];return '<div class="airline-bar-item'+(activeAircraft===ac?' active':'')+'" data-aircraft="'+ac+'"><div class="airline-name" style="font-size:0.85rem">'+ac+'</div><div class="airline-track"><div class="airline-fill" style="width:'+(cnt/max*100).toFixed(1)+'%;background:'+col+'"></div></div><div class="airline-count">'+cnt+' flights</div></div>';}).join('');
  document.querySelectorAll('[data-aircraft]').forEach(function(el){el.addEventListener('click',function(){var ac=this.dataset.aircraft;if(activeAircraft===ac){activeAircraft='';}else{activeAircraft=ac;}applyFilters();});});
}

function renderMfrBars(data){
  var counts={};data.forEach(function(f){if(f.mfr)counts[f.mfr]=(counts[f.mfr]||0)+1;});
  var sorted=Object.entries(counts).sort(function(a,b){return b[1]-a[1];});var max=sorted[0]?sorted[0][1]:1;
  var mfrColors={Boeing:'#1a7abf',Airbus:'#0050a0',Embraer:'#00875a',Bombardier:'#c85000',ATR:'#7c3aed'};
  document.getElementById('mfrBars').innerHTML=sorted.map(function(e,i){var mfr=e[0],cnt=e[1];var col=mfrColors[mfr]||'#4b5563';return '<div class="airline-bar-item'+(activeMfr===mfr?' active':'')+'" data-mfr="'+mfr+'"><div class="airline-name" style="font-size:0.85rem">'+mfr+'</div><div class="airline-track"><div class="airline-fill" style="width:'+(cnt/max*100).toFixed(1)+'%;background:'+col+'"></div></div><div class="airline-count">'+cnt+' flights</div></div>';}).join('');
  document.querySelectorAll('[data-mfr]').forEach(function(el){el.addEventListener('click',function(){var mfr=this.dataset.mfr;if(activeMfr===mfr){activeMfr='';document.getElementById('mfrFilter').value='';}else{activeMfr=mfr;document.getElementById('mfrFilter').value=mfr;}applyFilters();});});
}

function renderTable(data){
  document.getElementById('countShown').textContent=data.length;
  document.getElementById('countTotal').textContent=flightData.length;
  var body=document.getElementById('flightBody'),noR=document.getElementById('noResults');
  if(!data.length){body.innerHTML='';noR.style.display='block';return;}
  noR.style.display='none';
  body.innerHTML=data.map(function(f,i){return '<tr><td class="td-num">'+f.n+'</td><td class="td-date">'+f.date+'</td><td><div class="route-cell"><strong>'+f.dep+'</strong><span class="route-arrow">&rarr;</span><strong>'+f.arr+'</strong></div></td><td><span class="airline-badge badge-'+f.airline+'">'+f.airline+'</span></td><td class="fn-cell">'+f.fn+'</td><td class="ac-cell">'+f.ac+'</td><td class="ac-cell" style="font-size:0.78rem">'+f.mfr+'</td><td class="km-cell">'+Math.round(f.km*0.621371).toLocaleString()+' mi</td><td class="h-cell">'+fmtH(f.h)+'</td><td class="comment-cell">'+(f.comment||'')+'</td>'+(guestMode?'':'<td><button class="btn-del" data-id="'+f.id+'" data-n="'+f.n+'">&times;</button></td>')+'</tr>';}).join('');
  document.querySelectorAll('.btn-del').forEach(function(btn){btn.addEventListener('click',function(e){e.stopPropagation();openConfirm(this.dataset.id,this.dataset.n);});});
}

function sortAndRender(){
  filtered.sort(function(a,b){var av=a[sortCol],bv=b[sortCol];if(typeof av==='string')return av.localeCompare(bv)*sortDir;return(av-bv)*sortDir;});
  renderTable(filtered);
}

document.querySelectorAll('th[data-col]').forEach(function(th){th.addEventListener('click',function(){var col=this.dataset.col;if(sortCol===col)sortDir*=-1;else{sortCol=col;sortDir=1;}document.querySelectorAll('th').forEach(function(t){t.classList.remove('sort-asc','sort-desc');});this.classList.add(sortDir===1?'sort-asc':'sort-desc');sortAndRender();});});

function applyFilters(){
  var q=document.getElementById('searchInput').value.toLowerCase().trim();
  var al=document.getElementById('airlineFilter').value;
  var mfr=document.getElementById('mfrFilter').value;
  filtered=flightData.filter(function(f){
    var mq=!q||[f.dep,f.arr,f.airline,f.fn,f.ac,f.acs,f.mfr,f.reg,f.date,f.comment].some(function(v){return String(v).toLowerCase().includes(q);});
    var apq=!activeAirport||(f.dep===activeAirport||f.arr===activeAirport);
    return mq&&apq&&(!al||f.airline===al)&&(!mfr||f.mfr===mfr)&&(!activeAirline||f.airline===activeAirline)&&(!activeAircraft||f.acs===activeAircraft)&&(!activeMfr||f.mfr===activeMfr);
  });
  sortAndRender();renderStats(filtered);renderAirlineBars(flightData);renderAircraftBars(flightData);renderMfrBars(flightData);renderHeaderStats(filtered);updateClearBtn();
}

document.getElementById('searchInput').addEventListener('input',applyFilters);
document.getElementById('airlineFilter').addEventListener('change',function(){activeAirline=this.value;applyFilters();});
document.getElementById('mfrFilter').addEventListener('change',function(){activeMfr=this.value;applyFilters();});

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(){document.getElementById('modalOverlay').classList.add('open');document.getElementById('f-date').focus();}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');document.querySelectorAll('.field input.err,.field select.err').forEach(function(el){el.classList.remove('err');});}
document.getElementById('addFlightBtn').addEventListener('click',openModal);
document.getElementById('modalCloseBtn').addEventListener('click',closeModal);
document.getElementById('modalCancelBtn').addEventListener('click',closeModal);
document.getElementById('modalOverlay').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('f-airline').addEventListener('change',function(){document.getElementById('airlineOtherWrap').style.display=this.value==='__other'?'flex':'none';});
document.getElementById('f-mfr').addEventListener('change',function(){document.getElementById('mfrOtherWrap').style.display=this.value==='__other'?'flex':'none';});
['f-dep','f-arr','f-reg'].forEach(function(id){document.getElementById(id).addEventListener('input',function(){this.value=this.value.toUpperCase();});});

document.getElementById('modalSubmitBtn').addEventListener('click',function(){
  var ok=true;
  ['f-date','f-dep','f-arr','f-km'].forEach(function(id){var el=document.getElementById(id);el.classList.remove('err');if(!el.value.trim()){el.classList.add('err');ok=false;}});
  var alEl=document.getElementById('f-airline');alEl.classList.remove('err');if(!alEl.value){alEl.classList.add('err');ok=false;}
  var hrsEl=document.getElementById('f-h-hrs'),minEl=document.getElementById('f-h-min');
  var hrs=parseInt(hrsEl.value)||0,mins=parseInt(minEl.value)||0;
  var h=hrs+(mins/60);
  var km_mi=parseInt(document.getElementById('f-km').value);var km=Math.round(km_mi/0.621371);
  if(h<=0){hrsEl.classList.add('err');minEl.classList.add('err');ok=false;}
  if(isNaN(km_mi)||km_mi<=0){document.getElementById('f-km').classList.add('err');ok=false;}
  if(!ok){showToast('Please fill in required fields',true);return;}
  var alV=alEl.value==='__other'?document.getElementById('f-airline-other').value.trim():alEl.value;
  var mfrS=document.getElementById('f-mfr').value;
  var mfrV=mfrS==='__other'?document.getElementById('f-mfr-other').value.trim()||'Other':mfrS||'Unknown';
  var nextN=flightData.length?Math.max.apply(null,flightData.map(function(f){return f.n;}))+1:1;
  var newFlight={n:nextN,date:document.getElementById('f-date').value.trim(),airline:alV,fn:document.getElementById('f-fn').value.trim(),dep:document.getElementById('f-dep').value.trim().toUpperCase(),arr:document.getElementById('f-arr').value.trim().toUpperCase(),ac:document.getElementById('f-ac').value.trim(),acs:document.getElementById('f-acs').value.trim(),mfr:mfrV,reg:document.getElementById('f-reg').value.trim().toUpperCase(),h:Math.round(h*1000)/1000,km:km,comment:document.getElementById('f-comment').value.trim()};
  setSyncStatus('syncing','SAVING...');
  sb.from('flights').insert([newFlight]).select().then(function(res){
    if(res.error){showToast('Save failed: '+res.error.message,true);setSyncStatus('error','ERROR');return;}
    flightData.push(res.data[0]);
    ['f-date','f-fn','f-dep','f-arr','f-ac','f-acs','f-reg','f-h-hrs','f-h-min','f-km','f-comment','f-airline-other','f-mfr-other'].forEach(function(id){document.getElementById(id).value='';});
    document.getElementById('f-airline').value='';document.getElementById('f-mfr').value='';
    document.getElementById('airlineOtherWrap').style.display='none';document.getElementById('mfrOtherWrap').style.display='none';
    closeModal();renderAll();renderMap();setSyncStatus('connected','SYNCED');showToast('Flight added and saved to cloud!');
  });
});

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openConfirm(id,n){
  var f=flightData.find(function(x){return String(x.id)===String(id);});
  if(!f)return;
  pendingDeleteId=id;
  document.getElementById('confirmMsg').textContent='Delete '+f.fn+' ('+f.dep+' â†’ '+f.arr+') on '+f.date+'?';
  document.getElementById('confirmOverlay').classList.add('open');
}
function closeConfirm(){pendingDeleteId=null;document.getElementById('confirmOverlay').classList.remove('open');}
document.getElementById('confirmCancelBtn').addEventListener('click',closeConfirm);
document.getElementById('confirmOverlay').addEventListener('click',function(e){if(e.target===this)closeConfirm();});
document.getElementById('confirmDeleteBtn').addEventListener('click',function(){
  if(pendingDeleteId===null)return;
  var fn=flightData.find(function(f){return String(f.id)===String(pendingDeleteId);});
  var fnName=fn?fn.fn:'flight';
  setSyncStatus('syncing','DELETING...');
  sb.from('flights').delete().eq('id',pendingDeleteId).then(function(res){
    if(res.error){showToast('Delete failed: '+res.error.message,true);setSyncStatus('error','ERROR');return;}
    flightData=flightData.filter(function(f){return String(f.id)!==String(pendingDeleteId);});
    closeConfirm();renderAll();renderMap();setSyncStatus('connected','SYNCED');showToast(fnName+' deleted.');
  });
});

document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeModal();closeConfirm();}});


// â”€â”€ PASSWORD / MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var guestMode=false;
function applyMode(mode){
  guestMode=(mode==='guest');
  var adminEls=document.querySelectorAll('.admin-only');
  adminEls.forEach(function(el){el.style.display=guestMode?'none':'';});
  // Also re-render table to show/hide delete column
  if(flightData.length) renderAll();
}

(function(){
  var stored=sessionStorage.getItem('fl_auth');
  if(stored==='jedwin'||stored==='guest'){
    document.getElementById('pwScreen').style.display='none';
    applyMode(stored);
    return;
  }
  function unlock(){
    var val=document.getElementById('pwInput').value.trim();
    if(val==='jedwin'||val==='guest'){
      sessionStorage.setItem('fl_auth',val);
      var el=document.getElementById('pwScreen');
      el.style.transition='opacity 0.4s';el.style.opacity='0';
      setTimeout(function(){el.style.display='none';applyMode(val);},400);
    } else {
      var inp=document.getElementById('pwInput');
      inp.classList.add('err');
      document.getElementById('pwError').textContent='INCORRECT PASSWORD';
      inp.value='';
      setTimeout(function(){inp.classList.remove('err');},600);
    }
  }
  document.getElementById('pwSubmit').addEventListener('click',unlock);
  document.getElementById('pwInput').addEventListener('keydown',function(e){if(e.key==='Enter')unlock();});
  document.getElementById('pwToggle').addEventListener('click',function(){
    var inp=document.getElementById('pwInput');
    inp.type=inp.type==='password'?'text':'password';
  });
})();

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('exportBtn').addEventListener('click',function(){
  if(!flightData.length){showToast('No flights to export',true);return;}

  // Build CSV
  var headers=['#','Date','Airline','Flight Number','Departing','Arriving','Aircraft','Aircraft Short','Manufacturer','Registration','Duration (h)','Distance (km)','Comments'];
  var rows=flightData.map(function(f){
    return [f.n,f.date,f.airline,f.fn,f.dep,f.arr,f.ac,f.acs,f.mfr,f.reg,f.h,f.km,'"'+(f.comment||'').replace(/"/g,'""')+'"'].join(',');
  });
  var csv=[headers.join(',')].concat(rows).join('\n');

  // Also build JSON backup
  var json=JSON.stringify(flightData,null,2);

  // Download CSV
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='jacob_flights_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  URL.revokeObjectURL(a.href);

  // Download JSON after short delay
  setTimeout(function(){
    var blob2=new Blob([json],{type:'application/json'});
    var a2=document.createElement('a');
    a2.href=URL.createObjectURL(blob2);
    a2.download='jacob_flights_'+new Date().toISOString().slice(0,10)+'.json';
    a2.click();
    URL.revokeObjectURL(a2.href);
  },500);

  showToast('Exported '+flightData.length+' flights as CSV + JSON!');
});

// â”€â”€ INIT: Load from Supabase, seed if empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  setLoading(20,'CONNECTING TO DATABASE...');
  setSyncStatus('syncing','CONNECTING');
  try{
    setLoading(40,'LOADING YOUR FLIGHTS...');
    var res=await sb.from('flights').select('*').order('n',{ascending:true});
    if(res.error) throw res.error;

    if(res.data.length===0){
      // First time - migrate the seed data
      setLoading(60,'FIRST RUN: MIGRATING 118 FLIGHTS...');
      var chunks=[];
      for(var i=0;i<FLIGHTS.length;i+=20) chunks.push(FLIGHTS.slice(i,i+20));
      for(var c=0;c<chunks.length;c++){
        setLoading(60+Math.round((c/chunks.length)*30),'MIGRATING FLIGHTS '+(c*20+1)+'-'+Math.min((c+1)*20,FLIGHTS.length)+'...');
        var ins=await sb.from('flights').insert(chunks[c]);
        if(ins.error) throw ins.error;
      }
      // Reload after migration
      setLoading(95,'FINALIZING...');
      var res2=await sb.from('flights').select('*').order('n',{ascending:true});
      if(res2.error) throw res2.error;
      flightData=res2.data;
    } else {
      flightData=res.data;
    }

    setLoading(100,'READY!');
    setSyncStatus('connected','SYNCED');
    setTimeout(function(){
      hideLoading();
      renderAll();
      renderMap();
    },400);
  } catch(err){
    setLoading(100,'CONNECTION ERROR');
    setSyncStatus('error','ERROR');
    document.getElementById('loadingMsg').style.color='var(--red)';
    // Fall back to seed data
    flightData=FLIGHTS.map(function(f,i){return Object.assign({},f,{id:i+1});});
    setTimeout(function(){hideLoading();renderAll();renderMap();},1000);
    showToast('Could not connect to database. Running offline.',true);
  }
}

init();
</script>
</body>
</html>